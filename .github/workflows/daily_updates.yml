name: Daily Job Updates
on:
  schedule:
    - cron: '0 0 * * *'  # Runs once daily at midnight
  workflow_dispatch:

jobs:
  check_daily_jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Get and parse README
        run: |
          # Get current README content
          README_CONTENT=$(curl -s https://raw.githubusercontent.com/cvrve/New-Grad-2025/main/README.md)
          
          # Get today's date in the format used in README (MMM DD)
          TODAY=$(date '+%b %d')
          
          echo "README_CONTENT<<EOF" >> $GITHUB_ENV
          echo "$README_CONTENT" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV
          echo "TODAY=$TODAY" >> $GITHUB_ENV

      - name: Create Daily Jobs Issue
        uses: actions/github-script@v6
        with:
          script: |
            const content = process.env.README_CONTENT;
            const today = process.env.TODAY;
            
            // Parse the markdown table
            const jobSection = content.split('\n')
              .filter(line => line.startsWith('|'))
              .slice(2) // Skip header and separator
              .map(line => {
                const [_, company, role, location, link, date] = line.split('|').map(cell => cell.trim());
                return { company, role, location, date };
              })
              .filter(job => job.date.includes(today));
            
            if (jobSection.length > 0) {
              const bodyContent = `# New Jobs Posted Today (${today})
              
              ${jobSection.map(job => `
              ### ${job.company} - ${job.role}
              - üìç Location: ${job.location}
              `).join('\n')}
              
              [View all jobs](https://github.com/cvrve/New-Grad-2025)
              `;
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `New Job Postings - ${today}`,
                body: bodyContent,
                labels: ['daily-jobs']
              });
            }
