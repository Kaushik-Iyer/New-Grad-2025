name: Daily Job Updates
on:
  schedule:
    - cron: '0 0 * * *'  # Runs once daily at midnight
  workflow_dispatch:

jobs:
  check_daily_jobs:
    runs-on: ubuntu-latest
    steps:
      - name: Get and parse README
        run: |
          # Save README content to file instead of env var
          curl -s https://raw.githubusercontent.com/cvrve/New-Grad-2025/main/README.md > readme.txt
          
          # Get today's date in the format used in README (MMM DD)
          echo "TODAY=$(date '+%b %d')" >> $GITHUB_ENV

      - name: Create Daily Jobs Issue
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const content = fs.readFileSync('readme.txt', 'utf8');
            const today = process.env.TODAY;
            
            // Parse the markdown table
            const jobSection = content.split('\n')
              .filter(line => line.startsWith('|'))
              .slice(2)
              .map(line => {
                const [_, company, role, location, link, date] = line.split('|').map(cell => cell.trim());
                return { company, role, location, date };
              })
              .filter(job => job.date.includes(today));
            
            if (jobSection.length > 0) {
              const bodyContent = `# New Jobs Posted Today (${today})\n\n` +
                jobSection.map(job => 
                  `### ${job.company} - ${job.role}\n` +
                  `- üìç Location: ${job.location}\n`
                ).join('\n');
              
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `New Job Postings - ${today}`,
                body: bodyContent,
                labels: ['daily-jobs']
              });
            }
